name: Build
on:
  pull_request:
    branches: [develop]
    # Here we list file types that don't affect the build and don't need to use
    # up our Actions runners.
    paths-ignore:
      # draw.io (diagrams.net) files, the source of png images for docs
      - '**.drawio'
      # Example configuration files
      - '**.example'
      # Markdown documentation
      - '**.md'
      # Images for documentation
      - '**.png'
      # Templates for README files
      - '**.tpl'
      # Sample config files and OpenAPI docs
      - '**.yaml'
      # Bottlerocket Security Advisories
      - 'advisories/**'

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on:
      group: bottlerocket
      labels: bottlerocket_ubuntu-latest_32-core
    continue-on-error: true
    strategy:
      matrix:
        arch: [x86_64, aarch64]
      fail-fast: false
    name: "Build ${{ matrix.arch }}"
    steps:
      - name: Random delay
        run: |
          delay=$((1 + $RANDOM % 32))
          echo "Waiting ${delay} seconds before execution"
          sleep $delay
      - uses: actions/checkout@v4
      - name: Preflight step to set up the runner
        uses: ./.github/actions/setup-node
      - name: Install Rust nightly
        run: rustup toolchain install nightly
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
      - name: Build modified packages
        env:
          MODIFIED_FILES: ${{ steps.changed-files.outputs.modified_files }}
        run: |
          rm -rf target/
          rm -f tools/twoliter/twoliter
          BUILDSYS_CICD_HACK=1 make ARCH=${{ matrix.arch }}
          for file in ${MODIFIED_FILES} ; do
            find "${file}" -print -exec touch {} \;
          done
          make ARCH=${{ matrix.arch }}
